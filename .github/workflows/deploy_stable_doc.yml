name: Deploy Stable Documentation to GitHub Pages

on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  deploy-stable-docs:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      FORCE_COLOR: true
      UV_SYSTEM_PYTHON: 1
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    - name: Setup Python
      uses: actions/setup-python@v6
      with:
        python-version-file: "pyproject.toml"
    - name: Set up uv
      uses: astral-sh/setup-uv@v7
    - name: Install dependencies
      run: |
        uv pip install --group=docs --editable .
    - name: Update switcher.json with current stable version
      run: |
        python -c "
        import json, pingouin
        stable_version = pingouin.__version__
        switcher = [
            {
                'name': 'dev (main branch)',
                'version': 'dev',
                'url': 'https://pingouin-stats.org/dev/'
            },
            {
                'name': f'{stable_version} (stable)',
                'version': stable_version,
                'url': 'https://pingouin-stats.org/stable/',
                'preferred': True
            }
        ]
        with open('docs/switcher.json', 'w') as f:
            json.dump(switcher, f, indent=2)
            f.write('\n')
        print(f'Updated switcher.json with stable version {stable_version}')
        "
    - name: Build stable documentation
      env:
        DOC_VERSION: stable
      run: |
        make -C docs clean
        make -C docs html
    - name: Deploy stable docs to gh-pages (stable/ subfolder)
      uses: JamesIves/github-pages-deploy-action@v4
      with:
        folder: docs/build/html
        target-folder: stable
    - name: Create root redirect and switcher
      run: |
        mkdir -p /tmp/root-pages
        cp docs/switcher.json /tmp/root-pages/switcher.json
        cat > /tmp/root-pages/index.html << 'EOF'
        <!DOCTYPE html>
        <html>
          <head>
            <meta charset="utf-8">
            <meta http-equiv="refresh" content="0; url=stable/">
            <title>Pingouin Documentation</title>
          </head>
          <body>
            <p>Redirecting to <a href="stable/">stable documentation</a>...</p>
          </body>
        </html>
        EOF
    - name: Deploy root redirect and switcher to gh-pages
      uses: JamesIves/github-pages-deploy-action@v4
      with:
        folder: /tmp/root-pages
        clean: false
